services:
  # Ambilight extractor: Python daemon + Rust extractor binary
  ambilight-extractor:
    build:
      context: .
      dockerfile: Dockerfile.extractor
    container_name: ambilight-extractor
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ${DATA_PATH:-./data}:/app/data
      - ${MOVIES_PATH:-./test-media/movies}:/media/movies:ro
      - ${TV_PATH:-./test-media/tv}:/media/tv:ro
    # Hardware acceleration for Raspberry Pi 4B (V4L2 M2M devices)
    # Note: Colorspace conversion (yuv420p->rgb24) is NOT hardware-accelerated on Pi 4B
    # This is a known limitation - only decoding can be hardware-accelerated
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "2"
    devices:
      - /dev/video10:/dev/video10  # H.264 decoder
      - /dev/video11:/dev/video11  # H.264 encoder
      - /dev/video12:/dev/video12  # H.265 decoder
    # Alternative: use privileged mode (less secure but simpler)
    # privileged: true
    networks:
      homelab-network:
        ipv4_address: 10.1.0.20
    dns:
      - 192.168.1.191
      - 1.1.1.1

  ambilight-player:
    build:
      context: .
      dockerfile: Dockerfile.player
    container_name: ambilight-player
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ${DATA_PATH:-./data}:/app/data
      - ${MOVIES_PATH:-./test-media/movies}:/media/movies:ro
      - ${TV_PATH:-./test-media/tv}:/media/tv:ro
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "2"

    networks:
      homelab-network:
        ipv4_address: 10.1.0.21
    dns:
      - 192.168.1.191
      - 1.1.1.1
volumes:
  ambilight-data:

networks:
  homelab-network:
    external: true
