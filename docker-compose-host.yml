services:
  jellyfin-ambilight:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jellyfin-ambilight
    hostname: jellyfin-ambilight
    restart: unless-stopped

    # Use host networking - solves DNS issues completely
    network_mode: host

    environment:
      # Jellyfin Configuration (REQUIRED)
      - JELLYFIN_API_KEY=${JELLYFIN_API_KEY:-9b53498f4e1b4325a420fd705fea0020}
      - JELLYFIN_BASE_URL=${JELLYFIN_BASE_URL:-https://jellyfin.galagaon.com}

      # WLED Configuration
      - WLED_HOST=${WLED_HOST:-wled-ambilight-lgc1.lan}
      - WLED_UDP_PORT=${WLED_UDP_PORT:-21324}

      # LED Configuration
      - AMBILIGHT_TOP_LED_COUNT=${AMBILIGHT_TOP_LED_COUNT:-89}
      - AMBILIGHT_BOTTOM_LED_COUNT=${AMBILIGHT_BOTTOM_LED_COUNT:-89}
      - AMBILIGHT_LEFT_LED_COUNT=${AMBILIGHT_LEFT_LED_COUNT:-49}
      - AMBILIGHT_RIGHT_LED_COUNT=${AMBILIGHT_RIGHT_LED_COUNT:-49}
      - AMBILIGHT_INPUT_POSITION=${AMBILIGHT_INPUT_POSITION:-46}

      # Frame Extraction Settings
      - FRAMES_PER_SECOND=${FRAMES_PER_SECOND:-10}
      - EXTRACTION_PRIORITY=${EXTRACTION_PRIORITY:-newest_first}
      - EXTRACTION_BATCH_SIZE=${EXTRACTION_BATCH_SIZE:-5}

      # Service Intervals
      - LIBRARY_SCAN_INTERVAL=${LIBRARY_SCAN_INTERVAL:-1800}
      - PLAYBACK_MONITOR_INTERVAL=${PLAYBACK_MONITOR_INTERVAL:-0.5}

      # Storage
      - AMBILIGHT_DATA_DIR=/app/data/ambilight

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONUNBUFFERED=1

    volumes:
      # Source code mount (for development)
      - ./:/app/src:ro

      # Data persistence
      - ${DATA_PATH:-./data}:/app/data

      # Media access (READ-ONLY)
      - ${MOVIES_PATH:-./test-media/movies}:/media/movies:ro
      - ${TV_PATH:-./test-media/tv}:/media/tv:ro

    # Minimal resource usage
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-200M}
          cpus: '${CPU_LIMIT:-0.3}'
        reservations:
          memory: 50M
          cpus: '0.1'

    # DNS configuration (optional with host networking)
    dns:
      - 192.168.1.191
      - 8.8.8.8
      - 1.1.1.1

    labels:
      - "com.jellyfin.ambilight.type=simplified-alpine"
      - "com.jellyfin.ambilight.size=181MB"
      - "com.jellyfin.ambilight.description=Reliable host networking setup"
