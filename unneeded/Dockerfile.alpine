FROM python:3.11-alpine

# Set working directory
WORKDIR /app

# Install only essential system packages
RUN apk add --no-cache \
    ffmpeg \
    && rm -rf /var/cache/apk/*

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Create necessary directories
RUN mkdir -p /app/data/ambilight /app/data/logs

# Copy source code (volume-mounted in production)
COPY . /app/

# Simple startup script
RUN echo '#!/bin/sh\n\
echo "ðŸ³ Jellyfin Ambilight (Alpine)"\n\
echo "ðŸ’¿ Image size: ~100MB (vs 2GB+)"\n\
echo "ðŸ“Š Config: $JELLYFIN_BASE_URL -> $WLED_HOST:$WLED_UDP_PORT"\n\
echo "ðŸš€ Starting..."\n\
exec python3 -u ambilight-daemon-files.py\n\
' > /entrypoint.sh && chmod +x /entrypoint.sh

# Set environment defaults
ENV PYTHONUNBUFFERED=1 \
    AMBILIGHT_DATA_DIR=/app/data/ambilight \
    JELLYFIN_API_KEY="" \
    JELLYFIN_BASE_URL="" \
    WLED_HOST="wled-ambilight-lgc1.lan" \
    WLED_UDP_PORT="21324"

# Health check
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD python3 -c "import requests; requests.get('$JELLYFIN_BASE_URL/System/Info', headers={'Authorization': 'MediaBrowser Token=\"$JELLYFIN_API_KEY\"'}, timeout=5)" || exit 1

ENTRYPOINT ["/entrypoint.sh"]
