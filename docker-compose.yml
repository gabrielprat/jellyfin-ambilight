services:
  jellyfin-ambilight:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jellyfin-ambilight
    hostname: jellyfin-ambilight
    restart: unless-stopped

    # Use custom homelab network with static IP
    networks:
      homelab-network:
        ipv4_address: ${HOMELAB_IP}

    environment:
      # Jellyfin Configuration (REQUIRED)
      - JELLYFIN_API_KEY=${JELLYFIN_API_KEY:-9b53498f4e1b4325a420fd705fea0020}
      - JELLYFIN_BASE_URL=${JELLYFIN_BASE_URL:-https://jellyfin.galagaon.com}

      # WLED Configuration
      - WLED_HOST=${WLED_HOST:-wled-ambilight-lgc1.lan}
      - WLED_UDP_PORT=${WLED_UDP_PORT:-21324}
      - WLED_UDP_PROTOCOL=${WLED_UDP_PROTOCOL:-UDP_RAW}
      - WLED_UDP_RAW_PORT=${WLED_UDP_RAW_PORT:-19446}
      - WLED_LED_COUNT=${WLED_LED_COUNT:-300}

      # Device-WLED Pairing (Multi-room setup)
      - DEVICE_MATCH_FIELD=${DEVICE_MATCH_FIELD:-DeviceName}
      # Example device mappings (uncomment and configure as needed):
      # - WLED_DEVICE_LIVING_ROOM=wled-livingroom.lan:21324
      # - WLED_DEVICE_BEDROOM=wled-bedroom.lan:21324
      # - WLED_DEVICE_OFFICE=wled-office.lan:21324

      # LED Configuration
      - AMBILIGHT_TOP_LED_COUNT=${AMBILIGHT_TOP_LED_COUNT:-89}
      - AMBILIGHT_BOTTOM_LED_COUNT=${AMBILIGHT_BOTTOM_LED_COUNT:-89}
      - AMBILIGHT_LEFT_LED_COUNT=${AMBILIGHT_LEFT_LED_COUNT:-49}
      - AMBILIGHT_RIGHT_LED_COUNT=${AMBILIGHT_RIGHT_LED_COUNT:-49}
      - AMBILIGHT_INPUT_POSITION=${AMBILIGHT_INPUT_POSITION:-46}

      # Frame Extraction Settings
      - FRAMES_PER_SECOND=${FRAMES_PER_SECOND:-10}
      - EXTRACTION_PRIORITY=${EXTRACTION_PRIORITY:-newest_first}
      - EXTRACTION_BATCH_SIZE=${EXTRACTION_BATCH_SIZE:-5}
      - BLACK_BORDER_DETECTION=${BLACK_BORDER_DETECTION:-false}
      - BORDER_THRESHOLD=${BORDER_THRESHOLD:-10}

      # Service Intervals
      - LIBRARY_SCAN_INTERVAL=${LIBRARY_SCAN_INTERVAL:-1800}
      - PLAYBACK_MONITOR_INTERVAL=${PLAYBACK_MONITOR_INTERVAL:-0.05}
      - ENABLE_EXTRACTION=${ENABLE_EXTRACTION:-true}

      # Storage
      - AMBILIGHT_DATA_DIR=/app/data/ambilight

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONUNBUFFERED=1

    volumes:
      # Source code mount (for development)
      - ./:/app/src:ro

      # Data persistence
      - ${DATA_PATH:-./data}:/app/data

      # Media access (READ-ONLY)
      - ${MOVIES_PATH:-./test-media/movies}:/media/movies:ro
      - ${TV_PATH:-./test-media/tv}:/media/tv:ro

    # Minimal resource usage
    # Removed deploy resource limits to avoid cgroup warnings on non-supporting kernels

    # DNS configuration for homelab - multiple fallbacks for reliability
    dns:
      - 192.168.1.191  # Primary homelab DNS
      - 1.1.1.1        # Cloudflare DNS (fallback)
      - 8.8.8.8        # Google DNS (fallback)

    # Additional DNS options for reliability
    dns_opt:
      - timeout:2
      - attempts:3

    # Extra hosts for local resolution (optional)
    # extra_hosts:
    #   - "jellyfin.galagaon.com:${JELLYFIN_LOCAL_IP:-192.168.1.191}"

    labels:
      - "com.jellyfin.ambilight.type=simplified-alpine"
      - "com.jellyfin.ambilight.size=181MB"
      - "com.jellyfin.ambilight.description=10x smaller than original Debian setup"

networks:
  homelab-network:
    external: true
